pool:
  vmImage: 'ubuntu-16.04'
steps:

- task: DotNetCoreInstaller@2
  displayName: install dotnet core 3.0.100-preview8-013656
  inputs:
    version: "3.0.100-preview8-013656"

# NuGet tool installer
# Acquires a specific version of NuGet from the internet or the tools cache and adds it to the PATH. Use this task to change the version of NuGet used in the NuGet tasks.
- task: NuGetToolInstaller@0
  inputs:
    versionSpec: '5.1.0' 
    #checkLatest: false # Optional

# Push a project
- task: NuGetCommand@2
  inputs:
    command: 'custom'
    arguments: 'locals -clear all'

- task: NuGetCommand@2
  inputs:
    command: 'restore'
    feedsToUse: config
    nugetConfigPath: NuGet.config
    restoreSolution: 'NETCORE/*.sln'
    noCache: true
  continueOnError: true

- task: DotNetCoreCLI@1
  displayName: build all projects
  inputs:
    command: "build"
    projects: "NETCORE/src/**/**.csproj"
    arguments: "--configuration Release"

- task: DotNetCoreCLI@1
  displayName: Functional Tests 3.0
  continueOnError: true
  inputs:
    command: "test"
    projects: "NETCORE/test/**/TestApp30.Tests30.csproj"
    arguments: "--configuration Release -l trx"

- task: DotNetCoreInstaller@2
  displayName: install dotnet core 2.2.104
  inputs:
    version: "2.2.104"
    
- task: DotNetCoreCLI@1
  displayName: Functional Tests 2.0
  continueOnError: true
  inputs:
    command: "test"
    projects: "NETCORE/test/**/*Tests20.csproj"
    arguments: "--configuration Release -l trx"

- task: DotNetCoreCLI@1
  displayName: Unit Tests for AspNetCore
  continueOnError: true
  inputs:
    command: "test"
    projects: "NETCORE/test/**/*AspNetCore.Tests.csproj"
    arguments: "--configuration Release -l trx"

- task: DotNetCoreCLI@1
  displayName: Unit Tests + Func Tests for WorkerService
  continueOnError: true
  inputs:
    command: "test"
    projects: "NETCORE/test/**/*WorkerService.Tests.csproj"
    arguments: "--configuration Release -l trx"


- task: PublishTestResults@2
  inputs:
    testRunner: "VSTest"
    testResultsFiles: "**/*.trx"

- task: DotNetCoreCLI@1
  displayName: Package Nuget
  inputs:
    command: "pack"
    projects: "NETCORE/src/**/**.csproj"
    arguments: "--configuration Release --include-symbols --output $(build.artifactstagingdirectory)"

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: "$(build.artifactstagingdirectory)"
    ArtifactName: "drop"
    ArtifactType: "Container"